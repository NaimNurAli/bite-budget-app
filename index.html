<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Food Bill Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #f8fafc; /* slate-50 */
            --bg-card: #ffffff;
            --text-primary: #1e293b; /* slate-800 */
            --text-secondary: #64748b; /* slate-500 */
            --primary: #14b8a6; /* teal-500 */
            --primary-hover: #0d9488; /* teal-600 */
            --primary-light: #ccfbf1; /* teal-100 */
            --border-color: #e2e8f0; /* slate-200 */
        }
        html.dark {
            --bg-main: #0f172a; /* slate-900 */
            --bg-card: #1e293b; /* slate-800 */
            --text-primary: #f1f5f9; /* slate-100 */
            --text-secondary: #94a3b8; /* slate-400 */
            --primary-light: #134e4a; /* A dark teal */
            --border-color: #334155; /* slate-700 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* Overriding Tailwind utility classes for dark mode */
        html.dark .bg-white { background-color: var(--bg-card); }
        html.dark .bg-gray-50 { background-color: #334155; }
        html.dark .bg-gray-100 { background-color: var(--border-color); }
        html.dark .hover\:bg-gray-200:hover { background-color: #475569; }
        html.dark .bg-gray-200, html.dark .bg-gray-300 { background-color: #475569; }
        html.dark .hover\:bg-gray-300:hover, html.dark .hover\:bg-gray-400:hover { background-color: #64748b; }
        html.dark .border-t, html.dark .border-b, html.dark .border, html.dark .border-gray-100, html.dark .border-gray-200, html.dark .border-gray-300 {
            border-color: var(--border-color);
        }
        html.dark .text-gray-500, html.dark .text-gray-600 { color: var(--text-secondary); }
        html.dark .text-gray-700, html.dark .text-gray-800, html.dark .text-gray-900 { color: var(--text-primary); }
        html.dark input, html.dark select {
            background-color: #334155;
            color: var(--text-primary);
        }
        html.dark input::placeholder { color: var(--text-secondary); }
        html.dark .shadow-sm, html.dark .shadow-lg, html.dark .shadow-xl { box-shadow: none; }
        html.dark .nav-btn.active { background-color: var(--primary-light); }
        html.dark .nav-btn.active svg, html.dark .nav-btn.active span { color: #ffffff; } /* White for better contrast */
        html.dark .detail-tab.active { background-color: var(--primary-light); }
        html.dark .detail-tab.active, html.dark .detail-tab.active span { color: #ffffff; }
        html.dark .bg-black.bg-opacity-50 { background-color: rgba(0, 0, 0, 0.7); }

        details > summary {
            list-style: none;
            cursor: pointer;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details[open] summary .arrow {
            transform: rotate(90deg);
        }
        .arrow {
            transition: transform 0.2s;
        }
        .nav-btn {
            transition: transform 0.2s ease-in-out, background-color 0.2s ease-in-out;
        }
        .nav-btn.active {
            background-color: var(--primary-light);
            transform: translateY(-4px) scale(1.05);
            border-radius: 0.75rem;
            box-shadow: 0 4px 14px 0 rgba(0, 0, 0, 0.05);
        }
        .nav-btn.active svg,
        .nav-btn.active span {
            color: var(--text-primary);
        }
        .detail-tab {
            transition: all 0.2s ease-in-out;
            border-radius: 0.5rem 0.5rem 0 0;
        }
        .detail-tab.active {
            border-color: var(--primary);
            background-color: var(--primary-light);
            color: var(--text-primary);
            font-weight: 600;
            transform: translateY(-2px);
            box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.1), 0 -2px 4px -2px rgb(0 0 0 / 0.1);
        }
        #toastNotification {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translate(-50%, 40px);
            opacity: 0;
            pointer-events: none;
        }
        #toastNotification.show {
            transform: translate(-50%, 0);
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body class="antialiased">

<div class="container mx-auto max-w-lg p-3 pb-24">

    <!-- Page Views -->
    <div id="homeView" class="page">
        <header class="mb-6 relative flex items-center justify-between">
            <div class="flex-1 text-center">
                <h1 class="text-4xl font-extrabold tracking-tight flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-9 w-9 text-teal-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                    </svg>
                    <span class="bg-gradient-to-r from-teal-500 to-cyan-500 bg-clip-text text-transparent">
                        BiteBudget
                    </span>
                </h1>
                <p class="text-gray-500 mt-1 text-sm">Your personal food expense companion.</p>
            </div>
            <button id="themeToggle" class="absolute top-1/2 right-0 -translate-y-1/2 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                <svg id="themeIconSun" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <svg id="themeIconMoon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-300 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
        </header>


        <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
            <div class="flex justify-between items-baseline mb-3">
                <h2 class="text-lg font-semibold">Add Today's Expense</h2>
                <p id="expenseCategoryHint" class="text-sm text-teal-600 font-medium"></p>
            </div>
            <div class="flex items-center space-x-2">
                <input type="number" id="expenseAmount" placeholder="Enter amount" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400">
                <button id="addExpenseBtn" class="bg-teal-500 text-white px-5 py-2.5 rounded-lg font-semibold hover:bg-teal-600 transition duration-300 shadow-sm">Add</button>
            </div>
            <button id="manualEntryBtn" class="mt-3 w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition font-medium text-sm">
                Add a Missed or Past Expense
            </button>
        </div>

        <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
            <h2 class="text-lg font-semibold mb-3">Today's History</h2>
            <div id="todayHistory" class="space-y-2"></div>
        </div>

        <details class="bg-white rounded-xl shadow-sm" open>
            <summary class="p-4 flex justify-between items-center">
                <h2 class="text-lg font-semibold">Expense Chart <span id="chartMonthName" class="text-base font-medium text-gray-500 ml-1"></span></h2>
                <svg class="arrow h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
            </summary>
            <div class="relative h-80 p-4 pt-2">
                <canvas id="expenseChart"></canvas>
            </div>
        </details>
    </div>

    <div id="dailyView" class="page hidden"></div>
    <div id="weeklyView" class="page hidden"></div>
    <div id="monthlyView" class="page hidden"></div>

</div>

<!-- Bottom Navigation -->
<nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around max-w-lg mx-auto rounded-t-xl shadow-lg p-1">
    <button class="nav-btn flex-1 flex flex-col items-center justify-center p-2 text-gray-500" data-page="homeView">
        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
        <span class="text-xs font-medium mt-1">Home</span>
    </button>
    <button class="nav-btn flex-1 flex flex-col items-center justify-center p-2 text-gray-500" data-page="dailyView">
        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            <circle cx="12" cy="15" r="1.5" fill="currentColor" />
        </svg>
        <span class="text-xs font-medium mt-1">Daily</span>
    </button>
    <button class="nav-btn flex-1 flex flex-col items-center justify-center p-2 text-gray-500" data-page="weeklyView">
        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M7 15h10" />
        </svg>
        <span class="text-xs font-medium mt-1">Weekly</span>
    </button>
    <button class="nav-btn flex-1 flex flex-col items-center justify-center p-2 text-gray-500" data-page="monthlyView">
        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12h.01M12 12h.01M17 12h.01M7 16h.01M12 16h.01M17 16h.01" />
        </svg>
        <span class="text-xs font-medium mt-1">Monthly</span>
    </button>
</nav>


<!-- Modals -->
<div id="manualEntryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden p-4"><div class="bg-white p-5 rounded-xl shadow-xl w-full max-w-sm"><h2 class="text-xl font-bold text-gray-800 mb-2">Manual Entry</h2><p class="text-gray-500 mb-5 text-sm">Log an expense for today or a past date.</p><div class="space-y-4"><label class="block"><span class="text-gray-700 font-medium text-sm">Date</span><input type="date" id="manualDate" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring focus:ring-teal-200 focus:ring-opacity-50 py-2.5"></label><!-- Form for today's missed meals --><div id="manualEntryTodayForm"><label class="block"><span class="text-gray-700 font-medium text-sm">Category</span><select id="manualCategory" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring focus:ring-teal-200 focus:ring-opacity-50 py-2.5"></select></label><label class="block mt-4"><span class="text-gray-700 font-medium text-sm">Amount</span><input type="number" id="manualAmount" placeholder="" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring focus:ring-teal-200 focus:ring-opacity-50 py-2.5"></label></div><!-- Form for past days --><div id="manualEntryPastDayForm" class="hidden space-y-4"><div class="grid grid-cols-2 gap-4"><label class="block"><span class="text-gray-700 font-medium text-sm">Breakfast</span><input type="number" id="manualBreakfast" placeholder="" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm py-2.5"></label><label class="block"><span class="text-gray-700 font-medium text-sm">Lunch</span><input type="number" id="manualLunch" placeholder="" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm py-2.5"></label></div><div class="grid grid-cols-2 gap-4"><label class="block"><span class="text-gray-700 font-medium text-sm">Snacks</span><input type="number" id="manualSnacks" placeholder="" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm py-2.5"></label><label class="block"><span class="text-gray-700 font-medium text-sm">Dinner</span><input type="number" id="manualDinner" placeholder="" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm py-2.5"></label></div></div></div><div class="flex justify-end space-x-3 mt-5"><button id="cancelManualEntry" class="bg-gray-200 text-gray-800 px-5 py-2 rounded-lg hover:bg-gray-300 font-semibold text-sm">Cancel</button><button id="saveManualEntry" class="bg-teal-500 text-white px-5 py-2 rounded-lg hover:bg-teal-600 font-semibold shadow-sm text-sm">Save</button></div></div></div>
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"><div class="bg-white p-5 rounded-lg shadow-xl w-full max-w-sm"><h2 class="text-lg font-semibold mb-4">Edit Expense</h2><div class="space-y-4"><label class="block"><span class="text-gray-700 text-sm">Category</span><select id="editCategory" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring focus:ring-teal-200 focus:ring-opacity-50 py-2.5"></select></label><label class="block"><span class="text-gray-700 text-sm">Amount</span><input type="number" id="editAmount" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-teal-500 focus:ring focus:ring-teal-200 focus:ring-opacity-50 py-2.5"></label></div><div class="flex justify-end space-x-4 mt-6"><button id="cancelEdit" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 text-sm">Cancel</button><button id="saveEdit" class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 text-sm">Save</button></div></div></div>
<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"><div class="bg-white p-5 rounded-lg shadow-xl w-full max-w-sm"><h2 class="text-lg font-semibold mb-2">Are you sure?</h2><p id="confirmMessage" class="text-gray-600 mb-6 text-sm">Do you want to delete this expense?</p><div class="flex justify-end space-x-4"><button id="cancelDelete" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 text-sm">Cancel</button><button id="confirmDelete" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 text-sm">Delete</button></div></div></div>
<div id="alertModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden"><div class="bg-white p-5 rounded-lg shadow-xl w-full max-w-sm text-center"><p id="alertMessage" class="text-base text-gray-700 mb-6"></p><button id="alertOk" class="bg-teal-500 text-white px-6 py-2 rounded-lg hover:bg-teal-600 text-sm">OK</button></div></div>

<!-- Toast Notification -->
<div id="toastNotification" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-5 py-2.5 rounded-lg shadow-lg text-sm font-medium z-50">
    <p id="toastMessage"></p>
</div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        let expenses = [];
        let expenseChart;

        // --- Helper Function for Formatting ---
        const formatAmount = (amount) => {
            if (amount === undefined || amount === null) return '0';
            if (amount % 1 === 0) {
                return amount.toFixed(0);
            }
            return amount.toFixed(2);
        };

        const formatDate = (date) => {
            const d = new Date(date);
            let day = d.getDate().toString().padStart(2, '0');
            let month = (d.getMonth() + 1).toString().padStart(2, '0');
            let year = d.getFullYear();
            return `${day}/${month}/${year}`;
        };

        const formatTime = (date) => {
            return new Date(date).toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        };

        // DOM Elements
        const pages = document.querySelectorAll('.page');
        const navButtons = document.querySelectorAll('.nav-btn');
        const themeToggleBtn = document.getElementById('themeToggle');
        const themeIconSun = document.getElementById('themeIconSun');
        const themeIconMoon = document.getElementById('themeIconMoon');

        const addExpenseBtn = document.getElementById('addExpenseBtn');
        const expenseAmountInput = document.getElementById('expenseAmount');
        const todayHistoryDiv = document.getElementById('todayHistory');
        const expenseCategoryHint = document.getElementById('expenseCategoryHint');

        // Modal Elements
        const manualEntryModal = document.getElementById('manualEntryModal');
        const manualEntryBtn = document.getElementById('manualEntryBtn');
        const cancelManualEntryBtn = document.getElementById('cancelManualEntry');
        const saveManualEntryBtn = document.getElementById('saveManualEntry');
        const manualDateInput = document.getElementById('manualDate');
        const manualEntryTodayForm = document.getElementById('manualEntryTodayForm');
        const manualCategorySelect = document.getElementById('manualCategory');
        const manualAmountInput = document.getElementById('manualAmount');
        const manualEntryPastDayForm = document.getElementById('manualEntryPastDayForm');

        const editModal = document.getElementById('editModal');
        const editAmountInput = document.getElementById('editAmount');
        const editCategorySelect = document.getElementById('editCategory');
        const cancelEditBtn = document.getElementById('cancelEdit');
        const saveEditBtn = document.getElementById('saveEdit');
        let editingExpenseId = null;
        let editingExpenseIds = null;

        const confirmModal = document.getElementById('confirmModal');
        let deletingExpenseId = null;
        let deletingExpenseIds = null;

        const alertModal = document.getElementById('alertModal');
        const alertMessage = document.getElementById('alertMessage');
        const alertOkBtn = document.getElementById('alertOk');

        // Toast Elements
        const toastNotification = document.getElementById('toastNotification');
        const toastMessage = document.getElementById('toastMessage');
        let toastTimeout;

        // --- Theme Management ---
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeIconSun.classList.add('hidden');
                themeIconMoon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                themeIconSun.classList.remove('hidden');
                themeIconMoon.classList.add('hidden');
            }
            // Re-render chart with new theme colors
            renderChart();
        };

        const toggleTheme = () => {
            const currentTheme = localStorage.getItem('theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        };

        themeToggleBtn.addEventListener('click', toggleTheme);

        // --- Helper Functions ---
        const isSameDay = (d1, d2) => {
            return d1.getFullYear() === d2.getFullYear() &&
                d1.getMonth() === d2.getMonth() &&
                d1.getDate() === d2.getDate();
        };

        function updateExpenseHint() {
            const now = new Date();
            const category = getCategoryByTime(now);
            let mealTimeText = "";
            switch (category) {
                case "Breakfast": mealTimeText = "It's breakfast time!"; break;
                case "Lunch": mealTimeText = "It's lunchtime!"; break;
                case "Snacks": mealTimeText = "Time for a snack!"; break;
                case "Dinner": mealTimeText = "Time for dinner!"; break;
            }
            expenseCategoryHint.textContent = mealTimeText;
        }

        // --- Custom Notification Functions ---
        function showAlert(message) {
            alertMessage.textContent = message;
            alertModal.classList.remove('hidden');
        }
        alertOkBtn.addEventListener('click', () => alertModal.classList.add('hidden'));

        function showToast(message) {
            clearTimeout(toastTimeout); // Clear any existing timer
            toastMessage.textContent = message;
            toastNotification.classList.add('show');
            toastTimeout = setTimeout(() => {
                toastNotification.classList.remove('show');
            }, 3000); // Hide after 3 seconds
        }

        // --- View Navigation ---
        function showPage(pageId) {
            pages.forEach(page => {
                page.classList.toggle('hidden', page.id !== pageId);
            });
            navButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.page === pageId);
            });

            // Render content for the new page
            if (pageId === 'dailyView') renderDailyDetail();
            if (pageId === 'weeklyView') renderWeeklyDetail();
            if (pageId === 'monthlyView') renderMonthlyDetail();
        }

        navButtons.forEach(btn => {
            btn.addEventListener('click', () => showPage(btn.dataset.page));
        });

        // --- Local Storage ---
        const saveExpenses = () => localStorage.setItem('foodExpenses', JSON.stringify(expenses));
        function loadExpenses() {
            const stored = localStorage.getItem('foodExpenses');
            if (stored) {
                expenses = JSON.parse(stored).map(e => ({...e, timestamp: new Date(e.timestamp)}));
            }
            renderAll();
        }

        // --- Core App Logic ---
        addExpenseBtn.addEventListener('click', () => {
            const amount = parseFloat(expenseAmountInput.value);
            if (isNaN(amount) || amount <= 0) {
                showAlert("Please enter a valid, non-zero amount.");
                return;
            }
            const now = new Date();
            let expenseDate = new Date(now);
            let category = getCategoryByTime(now);

            // If it's before 6 AM, attribute it to the previous day's dinner.
            if (now.getHours() < 6) {
                expenseDate.setDate(expenseDate.getDate() - 1);
                // Also set the time to a reasonable "dinner" time to be picked up by filters
                expenseDate.setHours(22, 0, 0, 0); // e.g., 10 PM
                category = 'Dinner';
            }

            expenses.push({
                id: Date.now().toString(),
                amount,
                category: category,
                timestamp: expenseDate
            });

            saveExpenses();
            renderAll();
            expenseAmountInput.value = '';
        });

        const getCategoryByTime = (date) => {
            const hour = date.getHours();
            if (hour >= 6 && hour < 10) return 'Breakfast';
            if (hour >= 10 && hour < 16) return 'Lunch';
            if (hour >= 16 && hour < 19) return 'Snacks';
            return 'Dinner';
        };

        // --- Render Functions ---
        function renderAll() {
            expenses.sort((a, b) => b.timestamp - a.timestamp);

            const activePage = document.querySelector('.page:not(.hidden)').id;

            const dailyView = document.getElementById('dailyView');
            const openDetailsSummaries = [...dailyView.querySelectorAll('details[open] summary')];
            const openDates = openDetailsSummaries.map(summary => summary.querySelector('span.text-base').textContent);

            renderTodayHistory();
            renderChart();
            if (activePage === 'dailyView') renderDailyDetail();
            if (activePage === 'weeklyView') renderWeeklyDetail();
            if (activePage === 'monthlyView') renderMonthlyDetail();

            if (activePage === 'dailyView') {
                const allDetails = dailyView.querySelectorAll('details');
                allDetails.forEach(detail => {
                    const summaryDate = detail.querySelector('summary span.text-base').textContent;
                    if (openDates.includes(summaryDate)) {
                        detail.open = true;
                    }
                });
            }
        }

        function renderTodayHistory() {
            todayHistoryDiv.innerHTML = '';

            const now = new Date();
            const startOfFoodDay = new Date(now);
            if (now.getHours() < 6) {
                startOfFoodDay.setDate(startOfFoodDay.getDate() - 1);
            }
            startOfFoodDay.setHours(6, 0, 0, 0);

            const todaysExpenses = expenses.filter(e => e.timestamp >= startOfFoodDay);

            if (todaysExpenses.length === 0) {
                todayHistoryDiv.innerHTML = '<p class="text-gray-500 text-sm">No expenses recorded for today.</p>';
                return;
            }
            todaysExpenses.forEach(expense => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2.5 bg-gray-50 rounded-lg';
                div.innerHTML = `<p class="font-medium text-sm">${expense.category}</p><div class="flex items-center space-x-2"><p class="font-semibold text-base">₹${formatAmount(expense.amount)}</p><button class="edit-btn text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-100" data-id="${expense.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg></button><button class="delete-btn text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100" data-id="${expense.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button></div>`;
                todayHistoryDiv.appendChild(div);
            });
        }

        function renderDailyDetail() {
            const dailyView = document.getElementById('dailyView');
            dailyView.innerHTML = '';
            const expensesByDate = expenses.reduce((acc, expense) => {
                const dateKey = formatDate(expense.timestamp);
                if (!acc[dateKey]) acc[dateKey] = { expenses: [], total: 0 };
                acc[dateKey].expenses.push(expense);
                acc[dateKey].total += expense.amount;
                return acc;
            }, {});
            const sortedDates = Object.keys(expensesByDate).sort((a, b) => {
                const partsA = a.split('/');
                const dateA = new Date(partsA[2], partsA[1] - 1, partsA[0]);
                const partsB = b.split('/');
                const dateB = new Date(partsB[2], partsB[1] - 1, partsB[0]);
                return dateB - dateA;
            });

            if (sortedDates.length === 0) {
                dailyView.innerHTML = '<p class="text-gray-500 text-center mt-8 text-sm">No daily expenses to show.</p>';
                return;
            }

            const container = document.createElement('div');
            container.className = 'space-y-3';

            sortedDates.forEach(date => {
                const day = expensesByDate[date];

                const details = document.createElement('details');
                details.className = 'bg-white rounded-xl shadow-sm';

                const summary = document.createElement('summary');
                summary.className = 'p-3 flex justify-between items-center font-semibold';
                summary.innerHTML = `
                        <div class="flex flex-col">
                            <span class="text-base text-gray-800">${date}</span>
                            <span class="text-xs font-normal text-gray-500">${day.expenses.length} ${day.expenses.length === 1 ? 'entry' : 'entries'}</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-lg font-bold text-gray-900">₹${formatAmount(day.total)}</span>
                            <svg class="arrow h-5 w-5 ml-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                        </div>
                    `;
                details.appendChild(summary);

                const contentContainer = document.createElement('div');
                contentContainer.className = 'px-3 pb-3 border-t border-gray-200 pt-3 space-y-2';

                const categoryOrder = ['Breakfast', 'Lunch', 'Snacks', 'Dinner'];
                const sortedExpenses = day.expenses.sort((a,b) => categoryOrder.indexOf(a.category) - categoryOrder.indexOf(b.category));

                sortedExpenses.forEach(expense => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-2.5 bg-gray-50 rounded-lg';
                    item.innerHTML = `
                        <p class="font-medium text-sm">${expense.category}</p>
                        <div class="flex items-center space-x-2">
                            <p class="font-semibold text-base">₹${formatAmount(expense.amount)}</p>
                            <button class="edit-btn text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-100" data-id="${expense.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                            </button>
                            <button class="delete-btn text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100" data-id="${expense.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>`;
                    contentContainer.appendChild(item);
                });

                details.appendChild(contentContainer);
                container.appendChild(details);
            });
            dailyView.appendChild(container);
        }

        // --- Helper functions for Weekly View ---
        function getOrdinalSuffix(day) {
            if (day > 3 && day < 21) return 'th';
            switch (day % 10) {
                case 1: return "st";
                case 2: return "nd";
                case 3: return "rd";
                default: return "th";
            }
        }

        function getWeekDateRangeShort(year, month, weekNum) {
            let startDay, endDay;
            const lastDayOfMonth = new Date(year, month + 1, 0).getDate();

            if (weekNum === 1) { startDay = 1; endDay = 7; }
            else if (weekNum === 2) { startDay = 8; endDay = 14; }
            else if (weekNum === 3) { startDay = 15; endDay = 21; }
            else if (weekNum === 4) { startDay = 22; endDay = 28; }
            else { startDay = 29; endDay = lastDayOfMonth; }

            if (endDay > lastDayOfMonth) endDay = lastDayOfMonth;

            return `${startDay}${getOrdinalSuffix(startDay)} - ${endDay}${getOrdinalSuffix(endDay)}`;
        }

        function renderWeeklyDetail() {
            const weeklyView = document.getElementById('weeklyView');
            weeklyView.innerHTML = '';
            const expensesByCustomWeek = expenses.reduce((acc, expense) => {
                const d = expense.timestamp;
                const year = d.getFullYear();
                const month = d.getMonth();
                const date = d.getDate();
                let weekNum;

                if (date <= 7) weekNum = 1;
                else if (date <= 14) weekNum = 2;
                else if (date <= 21) weekNum = 3;
                else if (date <= 28) weekNum = 4;
                else weekNum = 5;

                const monthKey = `${year}-${month}`;
                const weekKey = `${monthKey}-Week${weekNum}`;

                if (!acc[weekKey]) {
                    acc[weekKey] = {
                        expenses: [],
                        total: 0,
                        monthName: d.toLocaleString('default', { month: 'long', year: 'numeric' }),
                    };
                }
                acc[weekKey].expenses.push(expense);
                acc[weekKey].total += expense.amount;
                return acc;
            }, {});

            const sortedMonthKeys = Object.keys(expensesByCustomWeek)
                .map(key => key.substring(0, key.lastIndexOf('-')))
                .filter((value, index, self) => self.indexOf(value) === index)
                .sort((a, b) => {
                    const [yearA, monthA] = a.split('-');
                    const [yearB, monthB] = b.split('-');
                    return new Date(yearB, monthB) - new Date(yearA, monthA);
                });

            if (sortedMonthKeys.length === 0) {
                weeklyView.innerHTML = '<p class="text-gray-500 text-center mt-8 text-sm">No weekly expenses to show.</p>';
                return;
            }

            sortedMonthKeys.forEach(monthKey => {
                const [year, month] = monthKey.split('-').map(Number);
                const monthName = new Date(year, month).toLocaleString('default', { month: 'long', year: 'numeric' });

                const weeksInMonth = [];
                let monthTotal = 0;
                for (let i = 1; i <= 5; i++) {
                    const weekKey = `${monthKey}-Week${i}`;
                    const week = expensesByCustomWeek[weekKey];
                    if (week) {
                        weeksInMonth.push({ ...week, weekNum: i, weekKey: weekKey });
                        monthTotal += week.total;
                    }
                }

                const details = document.createElement('details');
                details.className = 'bg-white rounded-xl shadow-sm mb-3';

                const summary = document.createElement('summary');
                summary.className = 'p-3 flex justify-between items-center font-semibold cursor-pointer';
                summary.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-lg text-gray-800">${monthName}</span>
                    </div>
                    <div class="flex items-center">
                        <span class="text-xl font-bold text-gray-900">₹${formatAmount(monthTotal)}</span>
                        <svg class="arrow h-5 w-5 ml-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    </div>
                `;
                details.appendChild(summary);

                const contentContainer = document.createElement('div');
                contentContainer.className = 'px-3 pb-3 border-t border-gray-200 pt-3';

                const tabNav = document.createElement('div');
                tabNav.className = 'flex border-b border-gray-200';
                const tabContentContainer = document.createElement('div');
                tabContentContainer.className = 'mt-3';

                weeksInMonth.forEach((week, index) => {
                    const tabButton = document.createElement('button');
                    tabButton.className = 'detail-tab flex-1 text-center py-1.5 px-3 -mb-px border-b-2 border-transparent text-gray-600 hover:text-teal-600';
                    const dateRange = getWeekDateRangeShort(year, month, week.weekNum);
                    tabButton.innerHTML = `<span class="font-semibold text-sm">Week ${week.weekNum}</span><span class="block text-xs text-gray-500">${dateRange}</span>`;
                    tabButton.dataset.target = week.weekKey;

                    const tabContent = document.createElement('div');
                    tabContent.id = week.weekKey;
                    tabContent.className = 'tab-pane hidden bg-white p-3 rounded-lg shadow-sm';

                    const dayTotals = week.expenses.reduce((acc, expense) => {
                        const dayName = expense.timestamp.toLocaleDateString('default', { weekday: 'short' });
                        const date = expense.timestamp.getDate();
                        const dayKey = `${dayName} (${date}${getOrdinalSuffix(date)})`;
                        acc[dayKey] = (acc[dayKey] || 0) + expense.amount;
                        return acc;
                    }, {});

                    const dayList = document.createElement('div');
                    dayList.className = 'space-y-2';
                    const sortedDays = Object.keys(dayTotals).sort((a, b) => parseInt(a.match(/\((\d+)/)[1]) - parseInt(b.match(/\((\d+)/)[1]));

                    sortedDays.forEach(dayKey => {
                        const total = dayTotals[dayKey];
                        const dayItem = document.createElement('div');
                        dayItem.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-md';
                        dayItem.innerHTML = `<p class="font-medium text-sm text-gray-700">${dayKey}</p><p class="font-semibold text-sm text-gray-800">₹${formatAmount(total)}</p>`;
                        dayList.appendChild(dayItem);
                    });
                    tabContent.appendChild(dayList);

                    const weekTotalFooter = document.createElement('div');
                    weekTotalFooter.className = 'flex justify-between items-center mt-3 pt-2 border-t border-gray-200 font-bold text-base';
                    weekTotalFooter.innerHTML = `<span>Week Total</span><span>₹${formatAmount(week.total)}</span>`;
                    tabContent.appendChild(weekTotalFooter);

                    if (index === 0) {
                        tabButton.classList.add('active');
                        tabContent.classList.remove('hidden');
                    }

                    tabNav.appendChild(tabButton);
                    tabContentContainer.appendChild(tabContent);
                });

                contentContainer.appendChild(tabNav);
                contentContainer.appendChild(tabContentContainer);
                details.appendChild(contentContainer);
                weeklyView.appendChild(details);

                tabNav.addEventListener('click', (e) => {
                    const targetButton = e.target.closest('.detail-tab');
                    if (targetButton) {
                        tabNav.querySelectorAll('.detail-tab').forEach(tab => tab.classList.remove('active'));
                        targetButton.classList.add('active');

                        tabContentContainer.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
                        tabContentContainer.querySelector(`#${CSS.escape(targetButton.dataset.target)}`).classList.remove('hidden');
                    }
                });
            });
        }

        function renderMonthlyDetail() {
            const monthlyView = document.getElementById('monthlyView');
            monthlyView.innerHTML = '';
            const expensesByMonth = expenses.reduce((acc, expense) => {
                const d = expense.timestamp;
                const monthKey = `${d.getFullYear()}-${d.getMonth()}`;
                const monthName = d.toLocaleString('default', { month: 'long', year: 'numeric' });
                if (!acc[monthKey]) {
                    acc[monthKey] = { total: 0, name: monthName, expenses: [] };
                }
                acc[monthKey].total += expense.amount;
                acc[monthKey].expenses.push(expense);
                return acc;
            }, {});

            const sortedMonths = Object.keys(expensesByMonth).sort((a, b) => {
                const [yearA, monthA] = a.split('-');
                const [yearB, monthB] = b.split('-');
                return new Date(yearB, monthB) - new Date(yearA, monthA);
            });

            if (sortedMonths.length === 0) {
                monthlyView.innerHTML = '<p class="text-gray-500 text-center mt-8 text-sm">No monthly expenses to show.</p>';
                return;
            }

            const monthList = document.createElement('div');
            monthList.className = 'space-y-3';

            sortedMonths.forEach(monthKey => {
                const month = expensesByMonth[monthKey];

                const details = document.createElement('details');
                details.className = 'bg-white rounded-xl shadow-sm';

                const summary = document.createElement('summary');
                summary.className = 'p-3 flex justify-between items-center font-semibold';
                summary.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-lg text-gray-800">${month.name}</span>
                    </div>
                    <div class="flex items-center">
                        <span class="text-xl font-bold text-gray-900">₹${formatAmount(month.total)}</span>
                        <svg class="arrow h-5 w-5 ml-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    </div>
                `;

                const content = document.createElement('div');
                content.className = 'px-3 pb-3 border-t border-gray-200';

                const categoryTotals = month.expenses.reduce((acc, expense) => {
                    acc[expense.category] = (acc[expense.category] || 0) + expense.amount;
                    return acc;
                }, {});

                const categoryOrder = ['Breakfast', 'Lunch', 'Snacks', 'Dinner'];
                const breakdownList = document.createElement('div');
                breakdownList.className = 'mt-3 space-y-2';

                categoryOrder.forEach(category => {
                    if (categoryTotals[category]) {
                        const item = document.createElement('div');
                        item.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-md';
                        item.innerHTML = `
                            <p class="font-medium text-sm text-gray-700">${category}</p>
                            <p class="font-semibold text-sm text-gray-800">₹${formatAmount(categoryTotals[category])}</p>
                        `;
                        breakdownList.appendChild(item);
                    }
                });

                if (breakdownList.children.length === 0) {
                    breakdownList.innerHTML = `<p class="text-sm text-gray-500 text-center py-2">No category breakdown available.</p>`;
                }

                content.appendChild(breakdownList);
                details.appendChild(summary);
                details.appendChild(content);
                monthList.appendChild(details);
            });

            monthlyView.appendChild(monthList);
        }

        function populateEditCategoryOptions(expense) {
            const now = new Date();
            editCategorySelect.innerHTML = ''; // Clear existing options

            let availableOptions = ['Breakfast', 'Lunch', 'Snacks', 'Dinner'];

            if (isSameDay(expense.timestamp, now)) {
                // It's an expense from today, so restrict options
                const hour = now.getHours();
                availableOptions = [];
                if (hour >= 6) availableOptions.push('Breakfast');
                if (hour >= 10) availableOptions.push('Lunch');
                if (hour >= 16) availableOptions.push('Snacks');
                if (hour >= 19) availableOptions.push('Dinner');
            }

            availableOptions.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                editCategorySelect.appendChild(option);
            });
        }

        // --- Event Delegation & Modal Controls ---
        document.body.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn) {
                deletingExpenseId = null;
                deletingExpenseIds = null;
                const originalIdsJSON = deleteBtn.dataset.originalIds;

                if (originalIdsJSON) {
                    deletingExpenseIds = JSON.parse(originalIdsJSON);
                } else {
                    deletingExpenseId = deleteBtn.dataset.id;
                }
                confirmModal.classList.remove('hidden');
            }
            const editBtn = e.target.closest('.edit-btn');
            if (editBtn) {
                editingExpenseId = null;
                editingExpenseIds = null;

                const originalIdsJSON = editBtn.dataset.originalIds;

                if (originalIdsJSON) { // Group edit from Daily View
                    editingExpenseIds = JSON.parse(originalIdsJSON);
                    const originalExpenses = expenses.filter(e => editingExpenseIds.includes(e.id));
                    const totalAmount = originalExpenses.reduce((sum, e) => sum + e.amount, 0);
                    const representativeExpense = originalExpenses[0];

                    if (representativeExpense) {
                        populateEditCategoryOptions(representativeExpense);
                        editAmountInput.value = totalAmount;
                        editCategorySelect.value = representativeExpense.category;
                        editModal.classList.remove('hidden');
                    }
                } else { // Single edit from Today's History
                    editingExpenseId = editBtn.dataset.id;
                    const expense = expenses.find(ex => ex.id === editingExpenseId);
                    if(expense) {
                        populateEditCategoryOptions(expense);
                        editAmountInput.value = expense.amount;
                        editCategorySelect.value = expense.category;
                        editModal.classList.remove('hidden');
                    }
                }
            }
        });

        // Manual Entry Modal Logic
        function updateManualCategoryOptions() {
            const hour = new Date().getHours();
            const options = [];
            if (hour >= 10) options.push('Breakfast');
            if (hour >= 16) options.push('Lunch');
            if (hour >= 19) options.push('Snacks');
            manualCategorySelect.innerHTML = options.length > 0
                ? options.map(opt => `<option>${opt}</option>`).join('')
                : '<option disabled>No missed meals yet</option>';
        }

        function updateManualEntryForm() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const selectedDate = new Date(manualDateInput.value);
            selectedDate.setHours(12, 0, 0, 0);

            if (selectedDate.getTime() < today.getTime()) {
                manualEntryTodayForm.classList.add('hidden');
                manualEntryPastDayForm.classList.remove('hidden');
            } else {
                manualEntryTodayForm.classList.remove('hidden');
                manualEntryPastDayForm.classList.add('hidden');
                updateManualCategoryOptions();
            }
        }
        manualEntryBtn.addEventListener('click', () => {
            const today = new Date().toISOString().split("T")[0];
            manualDateInput.max = today;
            manualDateInput.valueAsDate = new Date();
            updateManualEntryForm();
            manualEntryModal.classList.remove('hidden');
        });
        manualDateInput.addEventListener('change', updateManualEntryForm);
        cancelManualEntryBtn.addEventListener('click', () => manualEntryModal.classList.add('hidden'));
        saveManualEntryBtn.addEventListener('click', () => {
            const dateStr = manualDateInput.value;
            if (!dateStr) {
                showAlert("Please select a date.");
                return;
            }
            let entriesAdded = 0;
            let entriesMerged = 0;
            const selectedDate = new Date(dateStr + 'T12:00:00');

            const processEntry = (category, amount) => {
                if (isNaN(amount) || amount <= 0) {
                    return; // Skip zero or invalid amounts
                }
                expenses.push({ id: `${Date.now()}-${category}`, amount, category, timestamp: selectedDate });
                entriesAdded++;
            };

            if (!manualEntryTodayForm.classList.contains('hidden')) {
                const amount = parseFloat(manualAmountInput.value);
                if (amount > 0) {
                    const category = manualCategorySelect.value;
                    if(category) {
                        processEntry(category, amount);
                        manualAmountInput.value = '';
                    } else {
                        showAlert("No missed meal category available to select.");
                        return;
                    }
                } else if (manualAmountInput.value) {
                    showAlert("Please enter a valid, non-zero amount.");
                    return;
                }
            } else {
                const mealInputs = [
                    { category: 'Breakfast', input: document.getElementById('manualBreakfast') },
                    { category: 'Lunch', input: document.getElementById('manualLunch') },
                    { category: 'Snacks', input: document.getElementById('manualSnacks') },
                    { category: 'Dinner', input: document.getElementById('manualDinner') },
                ];
                mealInputs.forEach(meal => {
                    const amount = parseFloat(meal.input.value);
                    if (amount > 0) {
                        processEntry(meal.category, amount);
                        meal.input.value = '';
                    }
                });
            }

            if (entriesAdded > 0 || entriesMerged > 0) {
                saveExpenses();
                renderAll();
                let message = '';
                if (entriesAdded > 0) message += `${entriesAdded} new expense(s) added. `;
                if (entriesMerged > 0) message += `${entriesMerged} expense(s) merged.`;
                showToast(message.trim());
            } else {
                showToast("No new expenses were entered.");
            }
        });

        // Edit Modal
        saveEditBtn.addEventListener('click', () => {
            const newAmount = parseFloat(editAmountInput.value);
            if (isNaN(newAmount) || newAmount <= 0) {
                showAlert("Please enter a valid, non-zero amount.");
                return;
            }

            const newCategory = editCategorySelect.value;
            let idsToDelete = editingExpenseIds || (editingExpenseId ? [editingExpenseId] : []);

            if (idsToDelete.length === 0) return;

            const representativeExpense = expenses.find(e => e.id === idsToDelete[0]);
            if (!representativeExpense) return;

            const originalTimestamp = representativeExpense.timestamp;

            // 1. Remove all original expenses being edited
            expenses = expenses.filter(e => !idsToDelete.includes(e.id));

            // 2. Add back as a single new entry
            expenses.push({
                id: Date.now().toString(),
                amount: newAmount,
                category: newCategory,
                timestamp: originalTimestamp
            });
            showToast(`Expense for ${newCategory} updated.`);


            // 3. Cleanup and re-render
            saveExpenses();
            renderAll();
            editModal.classList.add('hidden');
            editingExpenseId = null;
            editingExpenseIds = null;
        });
        cancelEditBtn.addEventListener('click', () => editModal.classList.add('hidden'));

        // Delete Confirmation Modal
        document.getElementById('cancelDelete').addEventListener('click', () => confirmModal.classList.add('hidden'));
        document.getElementById('confirmDelete').addEventListener('click', () => {
            if (deletingExpenseIds) {
                expenses = expenses.filter(e => !deletingExpenseIds.includes(e.id));
            } else if (deletingExpenseId) {
                expenses = expenses.filter(e => e.id !== deletingExpenseId);
            }

            saveExpenses();
            renderAll();
            confirmModal.classList.add('hidden');
            deletingExpenseId = null;
            deletingExpenseIds = null;
        });

        const centerTextPlugin = {
            id: 'centerText',
            afterDraw: (chart) => {
                const { ctx, width, height } = chart;
                const textColor = chart.config.options.plugins.centerText.color || '#1e293b';
                const secondaryTextColor = document.documentElement.classList.contains('dark') ? '#94a3b8' : '#9ca3af';

                let centerX, centerY;
                if (chart.getDatasetMeta(0).data.length > 0) {
                    centerX = chart.getDatasetMeta(0).data[0].x;
                    centerY = chart.getDatasetMeta(0).data[0].y;
                } else {
                    centerX = width / 2;
                    centerY = height / 2;
                }

                if (chart.data.datasets.length === 0 || chart.data.datasets[0].data.length === 0) {
                    ctx.restore();
                    ctx.font = "600 1.2em Inter";
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = secondaryTextColor;
                    ctx.fillText("No data to display", centerX, centerY + 5);
                    ctx.save();
                    return;
                }

                let total = chart.config.options.plugins.centerText.total;
                ctx.restore();

                let formattedTotal = formatAmount(total);
                let text = `₹${formattedTotal}`;

                const maxFontSize = height / 10;
                const innerRadius = chart.innerRadius;
                const maxTextWidth = innerRadius * 2 * 0.8;

                ctx.font = `800 ${maxFontSize}px Inter`;
                let textWidth = ctx.measureText(text).width;

                let dynamicFontSize = maxFontSize;
                if (textWidth > maxTextWidth) {
                    dynamicFontSize = maxFontSize * (maxTextWidth / textWidth);
                }

                ctx.font = `800 ${dynamicFontSize}px Inter`;
                ctx.fillStyle = textColor;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(text, centerX, centerY + 5);
                ctx.save();
            }
        };

        // --- Chart ---
        function renderChart() {
            if (expenseChart) {
                expenseChart.destroy();
            }

            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? '#f1f5f9' : '#1e293b';
            const chartBorderColor = isDarkMode ? '#1e293b' : '#ffffff';

            const ctx = document.getElementById('expenseChart').getContext('2d');

            const now = new Date();
            const monthName = now.toLocaleString('default', { month: 'long' });
            const chartMonthNameSpan = document.getElementById('chartMonthName');
            if (chartMonthNameSpan) {
                chartMonthNameSpan.textContent = `(${monthName})`;
            }

            const currentMonthExpenses = expenses.filter(
                e => e.timestamp.getMonth() === now.getMonth() && e.timestamp.getFullYear() === now.getFullYear()
            );

            const currentMonthTotal = currentMonthExpenses.reduce((sum, e) => sum + e.amount, 0);

            const categoryTotals = currentMonthExpenses.reduce((acc, {category, amount}) => {
                acc[category] = (acc[category] || 0) + amount;
                return acc;
            }, {});

            const categoryOrder = ['Breakfast', 'Lunch', 'Snacks', 'Dinner'];
            const chartLabels = [];
            const chartData = [];
            const chartColors = {
                'Breakfast': '#fb923c', // orange-400
                'Lunch': '#60a5fa',     // blue-400
                'Snacks': '#facc15',    // amber-400
                'Dinner': '#4ade80'     // green-400
            };
            const chartBackgroundColors = [];

            categoryOrder.forEach(category => {
                if (categoryTotals[category]) {
                    chartLabels.push(category);
                    chartData.push(categoryTotals[category]);
                    chartBackgroundColors.push(chartColors[category]);
                }
            });

            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                plugins: [centerTextPlugin],
                data: {
                    labels: chartLabels,
                    datasets: [{
                        data: chartData,
                        backgroundColor: chartBackgroundColors,
                        borderColor: chartBorderColor,
                        borderWidth: 4,
                        cutout: '60%',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        centerText: {
                            total: currentMonthTotal,
                            color: textColor
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: textColor,
                                padding: 20,
                                boxWidth: 35,
                                font: { size: 14 },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const meta = chart.getDatasetMeta(0);
                                            const style = meta.controller.getStyle(i);
                                            const value = data.datasets[0].data[i];
                                            const amountText = value !== undefined ? `₹${formatAmount(value)}` : '₹0';
                                            return {
                                                text: `${label} - ${amountText}`,
                                                fillStyle: style.backgroundColor,
                                                strokeStyle: style.borderColor,
                                                lineWidth: style.borderWidth,
                                                hidden: !chart.isDatasetVisible(0),
                                                index: i,
                                                fontColor: textColor
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        datalabels: {
                            display: false,
                        }
                    }
                }
            });
        }

        // Initial Load
        loadExpenses();
        showPage('homeView');
        updateExpenseHint();
        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(savedTheme);
        setInterval(updateExpenseHint, 60000); // Update every minute
    });
</script>

</body>
</html>






